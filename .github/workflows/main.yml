name: 发布博客到OSS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: 安装 Hugo v0.145.0
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.145.0'
          extended: true

      - name: 构建网站
        run: hugo --minify

      - name: 下载并配置OSS工具
        run: |
          # 方法1：从官方GitHub仓库下载最新版 ossutil
          wget -O ossutil64 https://github.com/aliyun/ossutil/releases/download/v1.7.19/ossutil64
          chmod 755 ossutil64
          
          # 或者方法2：使用阿里云新的下载链接（如果上面的不行）
          # wget -O ossutil64 "https://gosspublic.alicdn.com/ossutil/1.7.19/ossutil64?spm=a2c4g.11186623.0.0.5a6d5f0e3pKdRf&file=ossutil64"
          
          # 验证下载是否成功
          ls -la ossutil64
          ./ossutil64 version

      - name: 清理并上传到OSS
        run: |
          # 使用命令行参数直接认证（避免配置文件问题）
          ./ossutil64 rm -rf oss://${{ secrets.OSS_BUCKET }} \
            -e ${{ secrets.OSS_ENDPOINT }} \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          
          ./ossutil64 cp -rf public/ oss://${{ secrets.OSS_BUCKET }} \
            -e ${{ secrets.OSS_ENDPOINT }} \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
