name: 发布博客到OSS

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: 安装 Hugo v0.145.0
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: '0.145.0'
          extended: true

      - name: 构建网站
        run: hugo --minify

      - name: 下载并配置OSS工具
        run: |
          # 下载最新版 ossutil
          wget -O ossutil64 https://gosspublic.alicdn.com/ossutil/1.7.19/ossutil64
          chmod 755 ossutil64
          
          # 直接使用命令行参数（避免配置文件问题）
          ./ossutil64 rm -rf oss://${{ secrets.OSS_BUCKET }} \
            -e ${{ secrets.OSS_ENDPOINT }} \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          
          ./ossutil64 cp -rf public/ oss://${{ secrets.OSS_BUCKET }} \
            -e ${{ secrets.OSS_ENDPOINT }} \
            -i ${{ secrets.OSS_ACCESS_KEY_ID }} \
            -k ${{ secrets.OSS_ACCESS_KEY_SECRET }}
